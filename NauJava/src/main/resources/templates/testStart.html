<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${test.testName} ?: 'Тест'">Начало теста</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f9f9f9; }
        h1 { color: #2c3e50; }
        .menu { margin: 20px 0; }
        .menu a {
            display: inline-block;
            margin: 8px;
            padding: 10px 16px;
            text-decoration: none;
            background-color: #3498db;
            color: white;
            border-radius: 4px;
        }
        .menu a:hover { background-color: #2980b9; }
    </style>
</head>
<body>
<div style="margin-bottom: 20px;">
    <label><strong>Ваше имя:</strong></label>
    <input type="text" id="participantName" placeholder="Введите ваше имя" required
           style="padding: 8px; font-size: 16px; margin-left: 10px;" />
</div>
<h1 th:text="${test.testName} ?: 'Тест'">Название теста</h1>

<div th:each="question, qStat : ${test.questions}">
    <h3 th:text="${qStat.index + 1 + '. ' + question.text}">Вопрос</h3>
    <div th:if="${question.type == T(ru.KostarevaAnastasia.NauJava.models.QuestionType).SINGLE}">
        <div th:each="option, oStat : ${question.options}">
            <label>
                <input type="radio"
                       th:name="'question_' + ${qStat.index}"
                       th:value="${option.id}" />
                <span th:text="${option.text}">Вариант</span>
            </label><br/>
        </div>
    </div>
    <div th:if="${question.type == T(ru.KostarevaAnastasia.NauJava.models.QuestionType).MULTIPLE}">
        <div th:each="option, oStat : ${question.options}">
            <label>
                <input type="checkbox"
                       th:name="'question_' + ${qStat.index}"
                       th:value="${option.id}" />
                <span th:text="${option.text}">Вариант</span>
            </label><br/>
        </div>
    </div>
</div>

<button type="button" onclick="submitTest()">Завершить тест</button>

<script th:inline="javascript">
    function submitTest() {
        const participantNameInput = document.getElementById('participantName');
        const participantName = participantNameInput?.value.trim();

        if (!participantName) {
            alert("Пожалуйста, введите ваше имя.");
            participantNameInput?.focus();
            return;
        }

        const answers = [];
        const questions = /*[[${test.questions}]]*/ [];

        questions.forEach((q, qIndex) => {
            let selected = [];
            if (q.type === 'SINGLE') {
                const radio = document.querySelector(`input[name='question_${qIndex}']:checked`);
                if (radio) {
                    selected = [Number(radio.value)];
                }
            } else if (q.type === 'MULTIPLE') {
                const checkboxes = document.querySelectorAll(`input[name='question_${qIndex}']:checked`);
                selected = Array.from(checkboxes).map(cb => Number(cb.value));
            }

            if (selected.length > 0) {
                answers.push({
                    questionId: q.id,
                    selectedOptionIds: selected
                });
            }
        });

        if (answers.length === 0) {
            alert("Вы не выбрали ни одного ответа!");
            return;
        }

        const payload = {
            participantName: participantName,
            answers: answers
        };

        fetch(/*[[@{/api/tests/{testId}/submit(testId=${test.testId})}]]*/, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if (res.ok) {
                return res.json();
            } else {
                return res.text().then(text => Promise.reject(text || 'Ошибка сервера'));
            }
        })
        .then(data => {
            alert(`Ваш результат: ${data.score} из ${data.maxScore} (${data.percentage}%)`);
            window.location.href = '/scores?name=' + encodeURIComponent(participantName);
        })
        .catch(err => {
            console.error("Ошибка:", err);
            alert('Не удалось отправить ответы. Подробности в консоли браузера.');
        });
    }
</script>
</body>
</html>